name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        default: 'v0.0.0-test'

jobs:
  firmware-build:
    name: Build Firmware (ESP-IDF)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build firmware with ESP-IDF
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: v5.5
          target: esp32

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: build/

  build-and-release:
    name: Build Host Tests and Create Release
    needs: firmware-build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download firmware artifact
        uses: actions/download-artifact@v4
        with:
          name: firmware
          path: build/

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++

      - name: Build and run host tests
        run: |
          cmake -S test -B build-host -DCMAKE_BUILD_TYPE=Debug
          cmake --build build-host
          ctest --test-dir build-host --output-on-failure

      - name: Archive all artifacts
        run: |
          mkdir -p release_artifacts
          cp -r build-host release_artifacts/
          cp build/partition_table/partition-table.bin release_artifacts/
          cp build/bootloader/bootloader.bin release_artifacts/
          cp build/parking_garage_control_system.bin release_artifacts/
          cp build/parking_garage_control_system.elf release_artifacts/

      - name: Prepare release notes from CHANGELOG
        id: changelog
        shell: bash
        run: |
          TAG="${GITHUB_REF##*/}"
          {
            echo "## ${TAG}"
            # Extract section between header [TAG] and next header starting with '## ['
            awk -v tag="$TAG" 'BEGIN{found=0} \
              /^## \[/ { \
                if(found){exit} \
              } \
              { \
                if($0 ~ "^## \[" tag "\]"){found=1; next} \
                if(found){print} \
              }' CHANGELOG.md | sed '/^\s*$/q'
          } > release_artifacts/RELEASE_NOTES.md || true
          echo "Notes generated:" && head -n 50 release_artifacts/RELEASE_NOTES.md || true
          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          cat release_artifacts/RELEASE_NOTES.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release_artifacts/*
          body: ${{ steps.changelog.outputs.release_body }}
